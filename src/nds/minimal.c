/*
  Dingoo minimal library by Alekmaul
  Base on Slaanesh's dingux port
  Based on Rlyeh's minimal.c for GP2X
*/
//#include <stddef.h>
//#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>

#include "ds2io.h"
#include "ds2_cpu.h"
#include "ds2_timer.h"
#include "fs_api.h"

//ALEK #define KEYBOARD 1
char gameDir[MAX_PATH];
//display*     gameDisplay  = NULL;

unsigned char                   *nds_screen8;
unsigned short                  *nds_screen15, *nds_screen15_down;
unsigned int                    *nds_screen32;
int                             nds_sound_rate=44100;
int                             nds_sound_stereo=0;
int                             rotate_controls=0;
unsigned short			nds_palette[256];

volatile unsigned long myClockTick=0;
#define MYTICKRATE 1000

#include "minimal.h"
#include "nds_sound.c"
#include "nds_cpu.c"
#include "osinline.h"
//#include "nds_keyboard.c"
void nds_clear_video(enum SCREEN_ID screen);

void nds_video_flip(void)
{
}


void nds_video_flip_single(void)
{
}


void nds_video_setpalette(void)
{
}

void nds_flush_video_up(void)
{
  ds2_flipScreen(UP_SCREEN, 0);
  nds_screen15 = up_screen_addr;
}

void nds_flush_video_down(void)
{
  ds2_flipScreen(DOWN_SCREEN, 2);
  nds_screen15_down = down_screen_addr;
}

unsigned long nds_joystick_read(void)
{
  struct key_buf input;
  ds2_getrawInput(&input);

  return input.key;
}

unsigned long nds_stylus_read(void)
{
  struct key_buf input;
  ds2_getrawInput(&input);

  return ( ((input.x & 0xFFFF)<< 16) | (input.y & 0xFFFF));
}

void nds_joystick_press (void)
{
  while(!nds_joystick_read());
}

void nds_sound_volume(int l, int r)
{
  extern int master_volume;
//  extern waveout_inst *_audio_music;
  l=l<0?0:l; l=l>100?100:l; r=r<0?0:r; r=r>100?100:r;
  if (l>0) master_volume=l;	/* Dont set if muting */
  l = ((l+r)/2)*127/100;
//  if (_audio_music) 
  ds2_setVolume(l);   
}

void nds_set_brightness(int value)
{
}

void mytimerClock(unsigned int arg) {
  myClockTick++;
}

void nds_timer_delay(unsigned int milliseconds)
{
  unsigned int now=nds_timer_read();
  while (nds_timer_read()-now<(milliseconds));
}

unsigned int nds_timer_read(void)
{
  return  myClockTick; 
}

void nds_timer_profile(void)
{
}

void nds_init(int rate, int bits, int stereo, unsigned int mhz, unsigned int brightness)
{
#if KEYBOARD
	OpenKeyboard();
	EnterGraphicsMode();
#endif
  //Interrupt period =100icrosec
  initTimer(1, 1000000/MYTICKRATE, mytimerClock, 0);
  runTimer(1);

  srand(getSysTime());

  /* map framebuffer to write to video */
  nds_screen15=up_screen_addr;
  nds_screen15_down=down_screen_addr;
  nds_screen8=(unsigned char *)nds_screen15; /* no 8-bit screen */
  nds_screen32=(unsigned int *)nds_screen15;

  /* clear screen */
  nds_clear_video(DUAL_SCREEN);

  /* sound volume */
  nds_sound_volume(50,50);

  /* set nds cpu speed */
//  if (mhz != NDS_DEFAULT_MHZ)
  {
    nds_set_clock(mhz);
  }

  /* set nds screen brightness */
  nds_set_brightness(brightness);
}

void nds_deinit(void)
{
  ds2_setCPUclocklevel(0);	/* default speed */
	
  nds_clear_video(DUAL_SCREEN);

#if KEYBOARD
  CloseKeyboard();
  LeaveGraphicsMode();
#endif
}

void nds_set_video_mode(int bpp,int width,int height)
{
  nds_clear_video(UP_SCREEN);

	/*
	 * Not much else to do here as we're are always using
	 * a 256 x 192 x 16bit screen
	 */
}

void nds_video_wait_vsync(void)
{
  /* Looks like this is impossible with the DSTWO's LCD */
}

void nds_clear_video(enum SCREEN_ID screen)
{
/*  unsigned int i;
  unsigned short *nds_screen = up_screen_addr;*/

  // Clear to black
  ds2_clearScreen(screen, 0); 
/*  for (i=0;i<256*192;i++)
    *(nds_screen+i)=RGB15(0,0,0);*/

  ds2_flipScreen(screen, 2);
}

static unsigned char fontdata8x8[] =
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x3C,0x42,0x99,0xBD,0xBD,0x99,0x42,0x3C,0x3C,0x42,0x81,0x81,0x81,0x81,0x42,0x3C,
	0xFE,0x82,0x8A,0xD2,0xA2,0x82,0xFE,0x00,0xFE,0x82,0x82,0x82,0x82,0x82,0xFE,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x64,0x74,0x7C,0x38,0x00,0x00,
	0x80,0xC0,0xF0,0xFC,0xF0,0xC0,0x80,0x00,0x01,0x03,0x0F,0x3F,0x0F,0x03,0x01,0x00,
	0x18,0x3C,0x7E,0x18,0x7E,0x3C,0x18,0x00,0xEE,0xEE,0xEE,0xCC,0x00,0xCC,0xCC,0x00,
	0x00,0x00,0x30,0x68,0x78,0x30,0x00,0x00,0x00,0x38,0x64,0x74,0x7C,0x38,0x00,0x00,
	0x3C,0x66,0x7A,0x7A,0x7E,0x7E,0x3C,0x00,0x0E,0x3E,0x3A,0x22,0x26,0x6E,0xE4,0x40,
	0x18,0x3C,0x7E,0x3C,0x3C,0x3C,0x3C,0x00,0x3C,0x3C,0x3C,0x3C,0x7E,0x3C,0x18,0x00,
	0x08,0x7C,0x7E,0x7E,0x7C,0x08,0x00,0x00,0x10,0x3E,0x7E,0x7E,0x3E,0x10,0x00,0x00,
	0x58,0x2A,0xDC,0xC8,0xDC,0x2A,0x58,0x00,0x24,0x66,0xFF,0xFF,0x66,0x24,0x00,0x00,
	0x00,0x10,0x10,0x38,0x38,0x7C,0xFE,0x00,0xFE,0x7C,0x38,0x38,0x10,0x10,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x1C,0x1C,0x18,0x00,0x18,0x18,0x00,
	0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x7C,0x28,0x7C,0x28,0x00,0x00,
	0x10,0x38,0x60,0x38,0x0C,0x78,0x10,0x00,0x40,0xA4,0x48,0x10,0x24,0x4A,0x04,0x00,
	0x18,0x34,0x18,0x3A,0x6C,0x66,0x3A,0x00,0x18,0x18,0x20,0x00,0x00,0x00,0x00,0x00,
	0x30,0x60,0x60,0x60,0x60,0x60,0x30,0x00,0x0C,0x06,0x06,0x06,0x06,0x06,0x0C,0x00,
	0x10,0x54,0x38,0x7C,0x38,0x54,0x10,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,
	0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x3E,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x04,0x08,0x10,0x20,0x40,0x00,0x00,
	0x38,0x4C,0xC6,0xC6,0xC6,0x64,0x38,0x00,0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00,
	0x7C,0xC6,0x0E,0x3C,0x78,0xE0,0xFE,0x00,0x7E,0x0C,0x18,0x3C,0x06,0xC6,0x7C,0x00,
	0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x00,0xFC,0xC0,0xFC,0x06,0x06,0xC6,0x7C,0x00,
	0x3C,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00,0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00,
	0x78,0xC4,0xE4,0x78,0x86,0x86,0x7C,0x00,0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00,
	0x00,0x00,0x18,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x18,0x18,0x30,
	0x1C,0x38,0x70,0xE0,0x70,0x38,0x1C,0x00,0x00,0x7C,0x00,0x00,0x7C,0x00,0x00,0x00,
	0x70,0x38,0x1C,0x0E,0x1C,0x38,0x70,0x00,0x7C,0xC6,0xC6,0x1C,0x18,0x00,0x18,0x00,
	0x3C,0x42,0x99,0xA1,0xA5,0x99,0x42,0x3C,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0x00,
	0xFC,0xC6,0xC6,0xFC,0xC6,0xC6,0xFC,0x00,0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00,
	0xF8,0xCC,0xC6,0xC6,0xC6,0xCC,0xF8,0x00,0xFE,0xC0,0xC0,0xFC,0xC0,0xC0,0xFE,0x00,
	0xFE,0xC0,0xC0,0xFC,0xC0,0xC0,0xC0,0x00,0x3E,0x60,0xC0,0xCE,0xC6,0x66,0x3E,0x00,
	0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00,0x7E,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,
	0x06,0x06,0x06,0x06,0xC6,0xC6,0x7C,0x00,0xC6,0xCC,0xD8,0xF0,0xF8,0xDC,0xCE,0x00,
	0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00,
	0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,
	0xFC,0xC6,0xC6,0xC6,0xFC,0xC0,0xC0,0x00,0x7C,0xC6,0xC6,0xC6,0xDE,0xCC,0x7A,0x00,
	0xFC,0xC6,0xC6,0xCE,0xF8,0xDC,0xCE,0x00,0x78,0xCC,0xC0,0x7C,0x06,0xC6,0x7C,0x00,
	0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,
	0xC6,0xC6,0xC6,0xEE,0x7C,0x38,0x10,0x00,0xC6,0xC6,0xD6,0xFE,0xFE,0xEE,0xC6,0x00,
	0xC6,0xEE,0x3C,0x38,0x7C,0xEE,0xC6,0x00,0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00,
	0xFE,0x0E,0x1C,0x38,0x70,0xE0,0xFE,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,
	0x60,0x60,0x30,0x18,0x0C,0x06,0x06,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,
	0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
	0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x06,0x3E,0x66,0x66,0x3C,0x00,
	0x60,0x7C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x3C,0x66,0x60,0x60,0x66,0x3C,0x00,
	0x06,0x3E,0x66,0x66,0x66,0x66,0x3E,0x00,0x00,0x3C,0x66,0x66,0x7E,0x60,0x3C,0x00,
	0x1C,0x30,0x78,0x30,0x30,0x30,0x30,0x00,0x00,0x3E,0x66,0x66,0x66,0x3E,0x06,0x3C,
	0x60,0x7C,0x76,0x66,0x66,0x66,0x66,0x00,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x00,
	0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x0C,0x38,0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00,
	0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0xEC,0xFE,0xFE,0xFE,0xD6,0xC6,0x00,
	0x00,0x7C,0x76,0x66,0x66,0x66,0x66,0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x3C,0x00,
	0x00,0x7C,0x66,0x66,0x66,0x7C,0x60,0x60,0x00,0x3E,0x66,0x66,0x66,0x3E,0x06,0x06,
	0x00,0x7E,0x70,0x60,0x60,0x60,0x60,0x00,0x00,0x3C,0x60,0x3C,0x06,0x66,0x3C,0x00,
	0x30,0x78,0x30,0x30,0x30,0x30,0x1C,0x00,0x00,0x66,0x66,0x66,0x66,0x6E,0x3E,0x00,
	0x00,0x66,0x66,0x66,0x66,0x3C,0x18,0x00,0x00,0xC6,0xD6,0xFE,0xFE,0x7C,0x6C,0x00,
	0x00,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x06,0x3C,
	0x00,0x7E,0x0C,0x18,0x30,0x60,0x7E,0x00,0x0E,0x18,0x0C,0x38,0x0C,0x18,0x0E,0x00,
	0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00,0x70,0x18,0x30,0x1C,0x30,0x18,0x70,0x00,
	0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x10,0x28,0x10,0x54,0xAA,0x44,0x00,0x00,
};

static void nds_text(unsigned short *screen, int x, int y, char *text, int color)
{
  unsigned int i,l;
  screen=screen+x+y*NDS_SCREEN_WIDTH;

  for (i=0;i<strlen(text);i++) {
		
	for (l=0;l<8;l++) {
		screen[l*NDS_SCREEN_WIDTH+0]=(fontdata8x8[((text[i])*8)+l]&0x80)?color:screen[l*NDS_SCREEN_WIDTH+0];
		screen[l*NDS_SCREEN_WIDTH+1]=(fontdata8x8[((text[i])*8)+l]&0x40)?color:screen[l*NDS_SCREEN_WIDTH+1];
		screen[l*NDS_SCREEN_WIDTH+2]=(fontdata8x8[((text[i])*8)+l]&0x20)?color:screen[l*NDS_SCREEN_WIDTH+2];
		screen[l*NDS_SCREEN_WIDTH+3]=(fontdata8x8[((text[i])*8)+l]&0x10)?color:screen[l*NDS_SCREEN_WIDTH+3];
		screen[l*NDS_SCREEN_WIDTH+4]=(fontdata8x8[((text[i])*8)+l]&0x08)?color:screen[l*NDS_SCREEN_WIDTH+4];
		screen[l*NDS_SCREEN_WIDTH+5]=(fontdata8x8[((text[i])*8)+l]&0x04)?color:screen[l*NDS_SCREEN_WIDTH+5];
		screen[l*NDS_SCREEN_WIDTH+6]=(fontdata8x8[((text[i])*8)+l]&0x02)?color:screen[l*NDS_SCREEN_WIDTH+6];
		screen[l*NDS_SCREEN_WIDTH+7]=(fontdata8x8[((text[i])*8)+l]&0x01)?color:screen[l*NDS_SCREEN_WIDTH+7];
	}
	screen+=8;
  } 
}

void nds_gamelist_text_out(int x, int y, char *eltexto)
{
	char texto[33];
	strncpy(texto,eltexto,32);
	texto[32]=0;
	if (texto[0]!='-')
		nds_text(nds_screen15_down,x+1,y+1,texto,NDS_BLACK);
	nds_text(nds_screen15_down,x,y,texto,NDS_WHITE);
}

/* Variadic functions guide found at http://www.unixpapa.com/incnote/variadic.html */
void nds_gamelist_text_out_fmt(int x, int y, char* fmt, ...)
{
	char strOut[128];
	va_list marker;
	
	va_start(marker, fmt);
	vsprintf(strOut, fmt, marker);
	va_end(marker);	

	nds_gamelist_text_out(x, y, strOut);
}

static int log=0;

void nds_printf_init(void)
{
  log=0;
}

static void nds_text_log(char *texto)
{
  if (!log)
  {
   nds_clear_video(DOWN_SCREEN);
  }
  nds_text(nds_screen15_down,0,log,texto,NDS_WHITE);
  log+=8;
  if(log>191) { log=0; }
}

/* Variadic functions guide found at http://www.unixpapa.com/incnote/variadic.html */
void nds_printf(char* fmt, ...)
{
	unsigned int i,c;
	char strOut[4096];
	char str[41];

	va_list marker;
	
	va_start(marker, fmt);
	vsprintf(strOut, fmt, marker);
	va_end(marker);	

	c=0;
	for (i=0;i<strlen(strOut);i++)
	{
		str[c]=strOut[i];
		if (str[c]=='\n')
		{
			str[c]=0;
			nds_text_log(str);
			c=0;
		}
		else if (c==31)
		{
			str[32]=0;
			nds_text_log(str);
			c=0;
		}		
		else
		{
			c++;
		}
	}
        nds_flush_video_down(); 
}

